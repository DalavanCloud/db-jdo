<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright 2005 The Apache Software Foundation

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at
  
       http://www.apache.org/licenses/LICENSE-2.0
  
    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<project default="default"
    xmlns:j="jelly:core"
    xmlns:ant="jelly:ant"
    xmlns:maven="jelly:maven"
    xmlns:u="jelly:util"
    >

    <!-- ==================== -->
    <!-- Default Global Goals -->
    <!-- ==================== -->

    <goal name="default">
        <attainGoal name="jar:install-snapshot"/>
    </goal>

    <goal name="build">
        <attainGoal name="default"/>
        <attainGoal name="setProps"/>
        <attainGoal name="privateInstallSchema"/>
        <attainGoal name="privateRuntck.jdori"/>
    </goal>

    <goal name="rebuild">
        <attainGoal name="clean"/>
        <attainGoal name="build"/>
    </goal>

    <goal name="clobber" prereqs="clean">
        <delete>
            <fileset dir="." defaultexcludes="no" includes="**/*~"/>
        </delete>
    </goal>

    <!-- ================== -->
    <!-- Set properties     -->
    <!-- ================== -->

    <goal name="setProps">
        <echo>setProps:</echo>

        <j:set var="zeroval" value="0"/>

        <j:set var="cfglist" value="${jdo.tck.cfglist}"/>
        <j:if test="${cfglist == null}">
            <u:properties file="${basedir}/test/conf/configurations.list"/>
        </j:if>

        <echo>Configurations for this run are ${jdo.tck.cfglist}</echo>
        <u:tokenize var="jdo.tck.cfglist" delim=" ">
            ${jdo.tck.cfglist}
        </u:tokenize>

        <echo>Databases for this run are ${jdo.tck.dblist}</echo>
        <u:tokenize var="jdo.tck.dblist" delim=" ">
            ${jdo.tck.dblist}
        </u:tokenize>

        <echo>Identity types for this run are ${jdo.tck.identitytypes}</echo>
        <u:tokenize var="jdo.tck.identitytypes" delim=" ">
            ${jdo.tck.identitytypes}
        </u:tokenize>

    </goal>

    <!-- ================== -->
    <!-- Install schema     -->
    <!-- ================== -->

    <goal name="installSchema" prereqs="setProps">
        <attainGoal name="privateInstallSchema"/>
    </goal>

    <goal name="privateInstallSchema">
        <!-- load mappings into a HashSet to unique them -->
        <j:new var="uniqueMappings" className="java.util.HashSet"/>
        <j:forEach var="cfg" items="${jdo.tck.cfglist}">
            <u:properties file="${basedir}/test/conf/${cfg}"/>
            <j:set var="mapping" value="${jdo.tck.mapping}"/>
            <expr value="${uniqueMappings.add(mapping)}"/>
        </j:forEach>

        <j:forEach var="jdo.tck.database" items="${jdo.tck.dblist}">
            <j:forEach var="jdo.tck.identitytype" items="${jdo.tck.identitytypes}">
                <j:forEach var="nextMapping"
                           items="${uniqueMappings.iterator()}">
                    <attainGoal name="doInstallSchema"/>
                </j:forEach>
            </j:forEach>
        </j:forEach>
    </goal>

    <goal name="doInstallSchema">
        <!-- Set schema name from mapping designator -->
        <j:choose>
            <j:when test="${nextMapping == zeroval}">
                <j:set var="jdo.tck.schema" value="schema.sql"/>
            </j:when>
            <j:otherwise>
                <j:set var="jdo.tck.schema" value="schema${nextMapping}.sql"/>
            </j:otherwise>
        </j:choose>

        <mkdir dir="${jdo.tck.testdir}/database/${jdo.tck.database}"/>
        <copy todir="${jdo.tck.testdir}/database/${jdo.tck.database}">
            <fileset dir="${basedir}/test/conf">
               <include name="${jdo.tck.database}.properties"/>
            </fileset>
        </copy>

        <echo>Install schema: ${jdo.tck.schema}
              for db ${jdo.tck.database} id ${jdo.tck.identitytype}</echo>
        <!-- todo: abstract the command line below for other databases -->
        <java classname="org.apache.derby.tools.ij" fork="true">
              <classpath>
                  <pathelement location="${derbytools.jarfile}"/>
                  <pathelement location="${derby.jarfile}"/>
              </classpath>
              <arg value="${basedir}/test/sql/${jdo.tck.database}/${jdo.tck.identitytype}/${jdo.tck.schema}"/>
              <sysproperty key="derby.system.home"
                      value="${jdo.tck.testdir}/database/${jdo.tck.database}"/>
        </java>
    </goal>

    <!-- ================== -->
    <!-- Run test cases     -->
    <!-- ================== -->

    <goal name="runtck.iut" prereqs="setProps">
        <attainGoal name="privateRuntck.iut"/>
    </goal>

    <goal name="privateRuntck.iut"
          prereqs="java:compile, testrunner.set, copyprops, doEnhance.iut, package.iut">
        <!-- Run tests for all databases, identity types, and configurations -->
        <echo>Run all configurations on iut</echo>
        <j:forEach var="jdo.tck.database" items="${jdo.tck.dblist}">
            <j:forEach var="jdo.tck.identitytype" items="${jdo.tck.identitytypes}">
                <j:forEach var="jdo.tck.cfg" items="${jdo.tck.cfglist}">
                    <!-- get jdo.tck.classes (list of testclasses),
                         jdo.tck.testdata, jdo.tck.mapping -->
                    <u:properties file="${basedir}/test/conf/${jdo.tck.cfg}"/>
                    <j:new var="schemaname" className="java.lang.String"/>
                    <j:set var="id" value="${jdo.tck.identitytype}"/>
                    <j:set var="mapping" value="${jdo.tck.mapping}"/>
                    <j:set var="schemaname">
                        <j:expr value="${schemaname.concat(id)}"/>
                        <j:expr value="${schemaname.concat(mapping)}"/>
                    </j:set>
                    <attainGoal name="doRuntck.iut"/>
                </j:forEach>
            </j:forEach>
        </j:forEach>
    </goal>

    <goal name="runtck.jdori" prereqs="setProps">
        <attainGoal name="privateRuntck.jdori"/>
    </goal>

    <goal name="privateRuntck.jdori"
          prereqs="java:compile, testrunner.set, copyprops, doEnhance.jdori, package.jdori">
        <!-- Run tests for all databases, identity types, and configurations -->
        <echo>Run all configurations on jdori</echo>
        <j:forEach var="jdo.tck.database" items="${jdo.tck.dblist}">
            <j:forEach var="jdo.tck.identitytype" items="${jdo.tck.identitytypes}">
                <j:forEach var="jdo.tck.cfg" items="${jdo.tck.cfglist}">
                    <u:properties file="${basedir}/test/conf/${jdo.tck.cfg}"/>
                    <j:new var="schemaname" className="java.lang.String"/>
                    <j:set var="id" value="${jdo.tck.identitytype}"/>
                    <j:set var="mapping" value="${jdo.tck.mapping}"/>
                    <j:set var="schemaname">
                        <j:expr value="${schemaname.concat(id)}"/>
                        <j:expr value="${schemaname.concat(mapping)}"/>
                    </j:set>
                    <attainGoal name="doRuntck.jdori"/>
                </j:forEach>
            </j:forEach>
        </j:forEach>
    </goal>

    <goal name="doRuntck.iut">
        <echo>Run JDO TCK on the IUT with configuration ${jdo.tck.configuration}</echo>
        <path id="this.project.class.path">
            <pathelement location="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}.jar"/>
            <path refid="project.class.path"/>
        </path>
        <j:set var="jdo.tck.testrunnerclass"
             value="org.apache.jdo.tck.util.BatchTestRunner"/>
        <java fork="yes" dir="${jdo.tck.testdir}"
              classname="${jdo.tck.testrunnerclass}">
            <classpath refid="this.project.class.path"/>
            <sysproperty key="ResultPrinterClass"
                         value="${jdo.tck.resultprinterclass}"/>
            <sysproperty key="verbose" value="${verbose}"/>
            <sysproperty key="PMFProperties" value="${iut.runtck.properties}"/>
            <sysproperty key="PMF2Properties" value="${iut.runtck.properties}"/>
            <sysproperty key="jdo.tck.testdata" value="${jdo.tck.testdata}"/>
            <sysproperty key="jdo.tck.standarddata"
                         value="${jdo.tck.standarddata}"/>
            <sysproperty key="jdo.tck.description"
                         value="${jdo.tck.description}"/>
            <sysproperty key="jdo.tck.identitytype"
                         value="${jdo.tck.identitytype}"/>
            <sysproperty key="jdo.tck.database"
                         value="${jdo.tck.database}"/>
            <sysproperty key="jdo.tck.cfg"
                         value="${jdo.tck.cfg}"/>
            <sysproperty key="jdo.tck.excludelist"
                         value="${jdo.tck.excludelist}"/>
            <sysproperty key="javax.jdo.option.Mapping"
                         value="${jdo.tck.mapping}"/>
            <sysproperty key="org.jpox.identifier.defaultSchemaName"
                         value="${schemaname}"/>
            <jvmarg line="${iut.runtck.sysproperties}"/>
            <jvmarg line="${iut.runtck.sysproperties}"/>
            <arg line="${jdo.tck.classes}"/>
        </java>
    </goal>

    <goal name="doRuntck.jdori">
        <path id="this.jdori.class.path">
            <pathelement location="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}.jar"/>
            <path refid="jdori.class.path"/>
        </path>
        <j:set var="jdo.tck.testrunnerclass"
               value="org.apache.jdo.tck.util.BatchTestRunner"/>
        <java fork="yes" dir="${jdo.tck.testdir}"
               classname="${jdo.tck.testrunnerclass}">
            <classpath refid="this.jdori.class.path"/>
            <sysproperty key="ResultPrinterClass"
                         value="${jdo.tck.resultprinterclass}"/>
            <sysproperty key="verbose" value="${verbose}"/>
            <sysproperty key="PMFProperties"
                         value="${basedir}/test/conf/jdori.properties"/>
            <sysproperty key="PMF2Properties"
                         value="${basedir}/test/conf/jdori.properties"/>
            <sysproperty key="jdo.tck.testdata" value="${jdo.tck.testdata}"/>
            <sysproperty key="jdo.tck.standarddata"
                         value="${jdo.tck.standarddata}"/>
            <sysproperty key="jdo.tck.description"
                         value="${jdo.tck.description}"/>
            <sysproperty key="jdo.tck.identitytype"
                         value="${jdo.tck.identitytype}"/>
            <sysproperty key="jdo.tck.database"
                         value="${jdo.tck.database}"/>
            <sysproperty key="jdo.tck.cfg"
                         value="${jdo.tck.cfg}"/>
            <sysproperty key="jdo.tck.excludelist"
                         value="${jdo.tck.excludelist}"/>
            <sysproperty key="javax.jdo.option.Mapping"
                         value="${jdo.tck.Mapping}"/>
            <sysproperty key="org.jpox.identifier.defaultSchemaName"
                         value="${schemaname}"/>
            <jvmarg line="${database.runtck.sysproperties}"/>
            <jvmarg line="${jdo.runtck.sysproperties}"/>
            <arg line="${jdo.tck.classes}"/>
        </java>
    </goal>

    <!-- ================== -->
    <!-- Enhance PC classes -->
    <!-- ================== -->

    <goal name="enhance.jdori" prereqs="setProps">
        <attainGoal name="doEnhance.jdori"/>
    </goal>

    <goal name="enhance.iut" prereqs="setProps">
        <attainGoal name="doEnhance.iut"/>
    </goal>

    <goal name="enhance.check">
        <condition property="enhancement.required">
            <not>
                <uptodate targetfile="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}.jar">
                    <srcfiles dir="${basedir}/test/jdo/${jdo.tck.identitytype}"
                          includes="org/apache/jdo/tck/pc/**/*.jdo, 
                                    org/apache/jdo/tck/pc/**/jdoTest.properties"/>
                    <srcfiles dir="${basedir}/test/java"
                          includes="${jdo.tck.pcclasses.sources},
                                    ${jdo.tck.paclasses.sources}"/>
                </uptodate>
            </not>
        </condition>
    </goal>

    <goal name="enhance.prepare">
        <!-- copy metadata -->
        <mkdir dir="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}" />
        <copy todir="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}">
            <fileset dir="${basedir}/test/jdo/${jdo.tck.identitytype}"
                     includes="**/*.jdo, **/jdoTest.properties"/>
        </copy>
        <!-- compile pc and pa classes -->
        <javac srcdir="${basedir}/test/java"
           includes="${jdo.tck.pcclasses.sources} ${jdo.tck.paclasses.sources}"
           destdir="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}"
           debug="on"
           classpathref="project.class.path">
        </javac>
        <!-- classpath -->
        <path id="this.enhance.class.path">
            <path refid="enhance.class.path"/>
            <pathelement location="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}"/>
        </path>

    </goal>

    <goal name="doEnhance.iut">
        <j:set var="jdo.tck.enhanced.dir" value="${iut.enhanced.dir}"/>
        <j:forEach var="jdo.tck.identitytype" items="${jdo.tck.identitytypes}">
            <attainGoal name="enhance.check"/>
            <j:if test="${enhancement.required}">
                <attainGoal name="enhance.prepare"/>
                <j:set var="iut.enhanced.dir"
                       value="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}"/>
                <echo>Run IUT enhancer for ${jdo.tck.identitytype}</echo>
                <java fork="yes" failonerror="yes" 
                      dir="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}"
                      classname="${iut.enhancer.main}"
                      classpathref="this.enhance.class.path">
                     <jvmarg line="${iut.enhancer.sysproperties}"/>
                     <arg line="${iut.enhancer.options}"/>
                     <arg line="${iut.enhancer.args}"/>
                </java>
            </j:if>
            <attainGoal name="package.iut"/>
        </j:forEach>
    </goal>

    <goal name="doEnhance.jdori">
        <j:set var="jdo.tck.enhanced.dir" value="${jdo.enhanced.dir}"/>
        <j:forEach var="jdo.tck.identitytype" items="${jdo.tck.identitytypes}">
            <attainGoal name="enhance.check"/>
            <j:if test="${enhancement.required}">
                <echo>Run JDORI enhancer for ${jdo.tck.identitytype}</echo>
                <attainGoal name="enhance.prepare"/>
                <j:set var="jdo.enhanced.dir"
                       value="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}"/>
                <java fork="yes" failonerror="yes" 
                      dir="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}"
                      classname="${jdo.enhancer.main}"
                      classpathref="this.enhance.class.path">
                     <jvmarg line="${jdo.enhancer.sysproperties}"/>
                     <arg line="${jdo.enhancer.options}"/>
                     <arg line="${jdo.enhancer.args}"/>
                </java>
            </j:if>
            <attainGoal name="package.jdori"/>
        </j:forEach>
    </goal>

    <!-- ========= -->
    <!-- Package   -->
    <!-- ========= -->

    <goal name="package.iut">
        <attainGoal name="package"/>
    </goal>

    <goal name="package.jdori">
        <attainGoal name="package"/>
    </goal>

    <goal name="package">
        <copy todir="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}">
            <fileset dir="${basedir}/test/orm/${jdo.tck.identitytype}"
                     includes="**/*.orm"/>
            <fileset dir="${basedir}/test/testdata"
                     includes="**/*.xml"/>
        </copy>
        <delete file="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}.jar"/>
        <jar jarfile="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}.jar">
            <fileset dir="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}" 
                 includes="**/*.class, **/*.jdo, **/*.orm, **/*.xml, **/jdoTest.properties"/>
        </jar>
    </goal>

    <!-- ========= -->
    <!-- Classpath -->
    <!-- ========= -->

    <ant:property file="${basedir}/test/conf/alltests.list"/>

    <path id="test_iut_jars" >
        <fileset dir="iut_jars" includes="*.jar"/>
    </path>

    <!-- Added jpox.enhancer.jarfile, renamed jpox.jdori.jarfile,
    added bcel.jarfile, log4j.jarfile(for jpox enhancer) -->
    <path id="project.class.path">
        <!-- Directory where enhanced class files are located  -->
        <pathelement location="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}/${jdo.tck.identitytype}.jar"/>
        <!-- Directory where JDOTCK class files are located  -->
        <pathelement location="${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}"/>
        <!-- <pathelement location="${jdo.tck.testclasses.dir}"/> -->
        <!-- JDO jar file  -->
        <pathelement location="${jdo.jdoapi.jarfile}"/>
        <!-- Jar files for the implementation to be tested -->
        <path refid="test_iut_jars" />
        <!-- JUnit jar file -->
        <pathelement location="${junit.jarfile}"/>
        <!-- Spring jar files -->
        <pathelement location="${spring.jarfile}"/>
        <pathelement location="${logging.jarfile}"/>
        <!-- Jar files for the reference implementation -->
        <pathelement location="${jpox.jdori.jarfile}" />
        <pathelement location="${jpox.enhancer.jarfile}" />
        <pathelement location="${jta.jarfile}" />
        <pathelement location="${xmlparser}" />
        <pathelement location="${bcel.jarfile}" />
        <pathelement location="${log4j.jarfile}" />
        <pathelement location="${derby.jarfile}" />
    </path>

    <!-- Paths needed for enhancement.  Must not include
        "${jdo.tck.enhanced.dir}/${jdo.tck.identitytype}.jar"  -->
    <path id="enhance.class.path">
        <!-- Directory where JDOTCK class files are located  -->
        <pathelement location="${jdo.tck.testclasses.dir}"/>
        <!-- JDO jar file  -->
        <pathelement location="${jdo.jdoapi.jarfile}"/>
        <!-- Jar files for the implementation to be tested -->
        <path refid="test_iut_jars" />
        <!-- JUnit jar file -->
        <pathelement location="${junit.jarfile}"/>
        <!-- Jar files for the reference implementation -->
        <pathelement location="${jpox.jdori.jarfile}" />
        <pathelement location="${jpox.enhancer.jarfile}" />
        <pathelement location="${jta.jarfile}" />
        <pathelement location="${xmlparser}" />
        <pathelement location="${bcel.jarfile}" />
        <pathelement location="${log4j.jarfile}" />
    </path>

    <path id="jdori.class.path">
        <!-- Directory where JDOTCK class files are located  -->
        <pathelement location="${jdo.tck.testclasses.dir}"/>
        <!-- JDO jar file  -->
        <pathelement location="${jdo.jdoapi.jarfile}"/>
        <pathelement location="${jta.jarfile}" />
        <!-- JUnit jar file -->
        <pathelement location="${junit.jarfile}"/>
        <!-- Spring jar files -->
        <pathelement location="${spring.jarfile}"/>
        <pathelement location="${logging.jarfile}"/>
        <!-- Jar files for the reference implementation -->
        <pathelement location="${jpox.jdori.jarfile}" />
        <pathelement location="${xmlparser}" />
        <pathelement location="${bcel.jarfile}" />
        <pathelement location="${log4j.jarfile}" />
        <pathelement location="${derby.jarfile}" />
        <pathelement location="${core20.jarfile}" />
        <pathelement location="${enhancer20.jarfile}" />
        <!-- Jar files for connection pooling -->
        <pathelement location="${jpox.dbcp.jarfile}" />
        <pathelement location="${jpox.c3p0.jarfile}" />
        <pathelement location="${c3p0.jarfile}"/>
        <pathelement location="${dbcp.jarfile}"/>
        <pathelement location="${pool.jarfile}"/>
        <pathelement location="${collections.jarfile}"/>
    </path>

    <!-- ==== -->
    <!-- Misc -->
    <!-- ==== -->

    <goal name="testrunner.set">
       <echo>testrunner.set:</echo>
       <condition property="jdo.tck.testrunnerclass" 
                  value="org.apache.jdo.tck.util.SwingTestRunner">
           <istrue value="${gui}"/>
       </condition>
       <condition property="jdo.tck.testrunnerclass" 
                  value="org.apache.jdo.tck.util.BatchTestRunner">
           <isfalse value="${gui}"/>
       </condition>
    </goal>

    <goal name="copyprops">
       <echo>copyprops:</echo>
        <copy todir="${jdo.tck.testclasses.dir}" >
            <fileset dir="${basedir}/test/conf">
               <include name="commons-logging.properties"/>
               <include name="simplelog.properties"/>
               <include name="logging.properties"/>
            </fileset>
            <fileset dir="${basedir}/test/java">
                <include name="**/*.xml"/>
            </fileset>
        </copy>
    </goal>

</project>
